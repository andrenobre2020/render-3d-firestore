<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PRODUTOS JP FLEX 3D </title>

  <style>
    :root{--bg:#0b1220;--card:#111827;--ink:#e5e7eb;--muted:#9ca3af;--accent:#3b82f6;}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif}
    main{max-width:1000px;margin:0 auto;padding:20px}
    .row{display:flex;gap:8px;flex-wrap:wrap}
    input,button{padding:12px;border-radius:10px;border:none}
    input{flex:1;background:#111827;color:#e5e7eb;border:1px solid #1f2937}
    button{background:var(--accent);color:#fff;font-weight:600;cursor:pointer}
    .status{margin-top:8px;font-size:13px;color:var(--muted);min-height:18px}
    .ok{color:#86efac}.err{color:#fca5a5}.warn{color:#fde68a}
    .layout{display:grid;grid-template-columns:1fr 320px;gap:16px;margin-top:16px}
    @media (max-width: 980px){.layout{grid-template-columns:1fr}}
    .viewer{border:1px solid #1f2937;border-radius:12px;overflow:hidden;background:#0b1020}
    model-viewer,canvas{width:100%;height:560px;display:none;background:#0b1020}
    .side{background:var(--card);border:1px solid #1f2937;border-radius:12px;padding:12px}
    .side h3{margin:0 0 10px 0;font-size:16px}
    ul#resultados{list-style:none;margin:0;padding:0;max-height:520px;overflow:auto}
    ul#resultados li{padding:8px 10px;border:1px solid #263042;border-radius:10px;margin-bottom:8px;cursor:pointer}
    ul#resultados li:hover{background:#0f1a2d}
    .controls{display:flex;flex-wrap:wrap;align-items:center;gap:8px;margin-top:10px}
    .controls > *{font-size:13px}
    .meta{margin-top:10px;padding:10px;border:1px dashed #374151;border-radius:10px;color:#cbd5e1;font:12px ui-monospace,Menlo,monospace;word-break:break-all}
  </style>

  <!-- model-viewer -->
  <script type="module" src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js"></script>

  <!-- Firebase compat -->
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

  <!-- Three.js import map -->
  <script type="importmap">
  {
    "imports": {
      "three": "https://unpkg.com/three@0.152.2/build/three.module.js",
      "three/addons/": "https://unpkg.com/three@0.152.2/examples/jsm/"
    }
  }
  </script>
</head>
<body>
  <main>
    <h1>PRODUTOS JP FLEX 3D </h1>

    <div class="row">
      <input id="busca" placeholder="Digite parte do nome (ex.: BUCHA)" />
      <button id="btnBuscar">Buscar exato</button>
      <button id="btnListar">Listar por prefixo</button>
    </div>
    <div id="status" class="status"></div>

    <div class="layout">
      <div class="viewer">
        <model-viewer id="mv" camera-controls auto-rotate enable-pan></model-viewer>
        <canvas id="cv"></canvas>
      </div>

      <aside class="side">
        <h3>Resultados</h3>
        <ul id="resultados"></ul>
        <div class="controls">
          <label><input type="checkbox" id="autoRotate" checked> Auto-rotar</label>
          <label><input type="checkbox" id="showGrid" checked> Mostrar grade</label>
          <button id="zoomIn">Zoom +</button>
          <button id="zoomOut">Zoom −</button>
          <button id="reset">Reset</button>
        </div>
        <div id="meta" class="meta" style="display:none"></div>
      </aside>
    </div>
  </main>

  <script type="module">
    import * as THREE from 'three';
    import { OBJLoader } from 'three/addons/loaders/OBJLoader.js';
    import { STLLoader } from 'three/addons/loaders/STLLoader.js';
    import { OrbitControls } from 'three/addons/controls/OrbitControls.js';

    console.log("🔥 Iniciando aplicação JP FLEX 3D DEBUG...");

    // ===== Firebase =====
    const firebaseConfig = {
      apiKey: "AIzaSyDRm8V72O97F0Jr9jquRqAB81zn7eNX-VY",
      authDomain: "graduacaofator.firebaseapp.com",
      projectId: "graduacaofator",
      storageBucket: "graduacaofator.appspot.com",
      messagingSenderId: "394958579615",
      appId: "1:394958579615:web:6d3726fe846c687300bfaa"
    };

    try {
      if (!firebase.apps?.length) firebase.initializeApp(firebaseConfig);
      console.log("✅ Firebase inicializado:", firebase.apps.length);
    } catch (e) {
      console.error("❌ Erro ao inicializar Firebase:", e);
    }

    const db = firebase.firestore();
    db.collection("models").limit(1).get()
      .then(s => console.log(`✅ Firestore conectado (${s.size} docs)`))
      .catch(e => console.error("❌ Erro Firestore:", e));

    // ===== Elementos UI =====
    const qEl = document.getElementById('busca');
    const statusEl = document.getElementById('status');
    const setStatus = (msg, cls="") => { statusEl.className="status "+cls; statusEl.textContent=msg||""; };

    const ul = document.getElementById('resultados');
    const mv = document.getElementById('mv');
    const cv = document.getElementById('cv');
    const metaEl = document.getElementById('meta');
    const autoRotateEl = document.getElementById('autoRotate');
    const showGridEl   = document.getElementById('showGrid');
    const zoomInEl     = document.getElementById('zoomIn');
    const zoomOutEl    = document.getElementById('zoomOut');
    const resetEl      = document.getElementById('reset');

    // ===== Helpers =====
    const norm = s => (s || "").normalize("NFD").replace(/\p{Diacritic}/gu,'').toLowerCase().trim();
    function showMeta(id, m){
      metaEl.style.display='block';
      metaEl.textContent = `docId: ${id}
nome: ${m.nome}
fileName: ${m.fileName}
downloadURL: ${m.downloadURL}`;
    }

    // ===== Buscar Exato =====
    async function buscarExato(){
      console.log("🟦 Clique em Buscar detectado");
      try{
        const nome = qEl.value.trim();
        if(!nome){ setStatus('Informe um nome (exato).','warn'); return; }
        setStatus('Buscando…');
        console.log("→ Buscando nome:", nome);

        const alvoFold = norm(nome);
        let snap = null;

        try {
          snap = await db.collection('models').where('nomeFold','==',alvoFold).limit(1).get();
          console.log("→ Query nomeFold retornou:", snap.size, "docs");
        } catch (err) {
          console.warn("⚠️ Erro na query nomeFold:", err);
        }

        if (snap && !snap.empty){
          const d = snap.docs[0], m = d.data();
          console.log("✅ Encontrado (nomeFold):", m.nome);
          renderByDoc(d.id, m);
          return;
        }

        const pref = await db.collection('models').limit(200).get();
        console.log("→ Fallback local (200 docs)");
        const hit = pref.docs.find(d => norm(d.data().nome) === alvoFold);
        if(!hit){ setStatus('Nada encontrado.','warn'); console.warn("❌ Nenhum match exato encontrado."); return; }

        console.log("✅ Encontrado (fallback local):", hit.data().nome);
        renderByDoc(hit.id, hit.data());
      }catch(e){ console.error("❌ Erro ao buscar:", e); setStatus('Erro ao buscar (veja console).','err'); }
    }

    // ===== Listar por prefixo =====
    async function listarPrefixo(){
      console.log("🟨 Listando por prefixo…");
      try{
        const p = qEl.value.trim();
        if(!p){ setStatus('Digite ao menos 1 caractere.','warn'); return; }
        setStatus('Listando…');

        const alvo = norm(p);
        console.log("→ Prefixo normalizado:", alvo);

        let docs = [];
        try{
          const start = alvo, end = alvo + '\uf8ff';
          const snap = await db.collection('models').orderBy('nomeFold').startAt(start).endAt(end).limit(50).get();
          if (!snap.empty){
            docs = snap.docs.map(d => ({id:d.id, data:d.data()}));
            console.log("✅ Query prefixo:", docs.length, "resultados");
            paintResults(docs);
            return;
          }
        } catch(e){ console.warn("⚠️ Erro query nomeFold prefixo:", e); }

        const wide = await db.collection('models').limit(200).get();
        docs = wide.docs.filter(d => norm(d.data().nome||'').includes(alvo)).map(d => ({id:d.id, data:d.data()}));
        console.log("→ Fallback local:", docs.length, "docs");
        paintResults(docs);
      }catch(e){ console.error("❌ Erro ao listar:", e); setStatus('Erro ao listar (console).','err'); }
    }

    function paintResults(docs){
      ul.innerHTML = "";
      setStatus(`Encontrados: ${docs.length}`,'ok');
      docs.forEach(({id,data:m})=>{
        const li = document.createElement('li');
        li.textContent = `${m.nome || '(sem nome)'} — ${m.fileName || ''}`;
        li.onclick = ()=> renderByDoc(id, m);
        ul.appendChild(li);
      });
    }

    // ===== Renderizador =====
    function renderByDoc(docId, m){
      console.log("🎨 Renderizando modelo:", m.fileName);
      showMeta(docId, m);
      const url = m.downloadURL;
      const ext = (m.fileName?.split('.').pop() || '').toLowerCase();
      if(!url){ setStatus('Documento sem downloadURL.','err'); return; }

      const proxied = '/.netlify/functions/fetch-3d?url=' + encodeURIComponent(url);
      if (ext === 'glb' || ext === 'gltf') renderGLTF(proxied);
      else if (ext === 'obj' || ext === 'stl') renderOBJorSTL(proxied, ext);
      else setStatus(`Tipo não suportado (.${ext}).`, 'err');
    }

    // ===== Render GLTF =====
    function renderGLTF(url){
      mv.style.display='block'; cv.style.display='none';
      mv.src = url;
      setStatus('Carregando GLB/GLTF…','ok');
    }

    // ===== Render OBJ/STL =====
    let scene, camera, renderer, controls, group, grid;
    const defaultDist = 6;

    function setupThree(){
      renderer?.dispose?.();
      scene = new THREE.Scene();
      scene.background = new THREE.Color(0x0b1020);

      const w = cv.clientWidth || 1000, h = 560;
      cv.width = w; cv.height = h;
      camera = new THREE.PerspectiveCamera(45, w/h, 0.05, 5000);
      camera.position.set(2.5, 2.0, 3.5);

      renderer = new THREE.WebGLRenderer({ canvas: cv, antialias: true });
      renderer.setSize(w, h);
      renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));

      scene.add(new THREE.HemisphereLight(0xffffff, 0x202020, 1.2));
      const dir = new THREE.DirectionalLight(0xffffff, 1);
      dir.position.set(3,5,2);
      scene.add(dir);

      group = new THREE.Group();
      scene.add(group);

      controls = new OrbitControls(camera, renderer.domElement);
      controls.enableDamping = true;
      controls.autoRotate = autoRotateEl.checked;

      new ResizeObserver(()=> {
        const W = cv.clientWidth || 1000, H = 560;
        cv.width = W; cv.height = H;
        renderer.setSize(W, H);
        camera.aspect = W/H;
        camera.updateProjectionMatrix();
      }).observe(cv);
    }

    function renderOBJorSTL(url, kind){
      mv.style.display='none'; cv.style.display='block';
      setupThree();

      const finish = (objOrGeo) => {
        let obj = objOrGeo;
        if (kind === 'stl') {
          obj = new THREE.Mesh(objOrGeo,new THREE.MeshStandardMaterial({ color: 0xcccccc }));
        }
        obj.traverse?.(n=>{ if(n.isMesh && !n.material) n.material = new THREE.MeshStandardMaterial({color:0xcccccc}); });
        group.clear(); group.add(obj);
        const box = new THREE.Box3().setFromObject(group);
        const center = new THREE.Vector3(); box.getCenter(center);
        group.position.sub(center);
        setStatus('Modelo carregado.','ok');
      };
      const onErr = e => { console.error("❌ Erro carregando modelo:", e); setStatus('Erro ao carregar (CORS/arquivo).','err'); };

      if (kind === 'obj') new OBJLoader().load(url, finish, undefined, onErr);
      else new STLLoader().load(url, geo=>finish(geo), undefined, onErr);

      (function animate(){
        requestAnimationFrame(animate);
        controls?.update();
        renderer.render(scene, camera);
      })();
    }

    // ===== Controles =====
    autoRotateEl.addEventListener('change', ()=>{ if(controls){ controls.autoRotate = autoRotateEl.checked; } });
    showGridEl.addEventListener('change', ()=>{ if(grid){ grid.visible = showGridEl.checked; } });
    zoomInEl.addEventListener('click', ()=>{ if(camera){ camera.position.multiplyScalar(0.9); } });
    zoomOutEl.addEventListener('click', ()=>{ if(camera){ camera.position.multiplyScalar(1.1); } });
    resetEl.addEventListener('click', ()=>{ if(camera){ camera.position.set(0,1.5,defaultDist); controls.target.set(0,0,0); controls.update(); } });

    // ===== Botões =====
    document.getElementById('btnBuscar').addEventListener('click', buscarExato);
    document.getElementById('btnListar').addEventListener('click', listarPrefixo);

    if (location.protocol === 'file:') setStatus('⚠️ Abra via http(s) (não file://)', 'warn');
  </script>
</body>
</html>
