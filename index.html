<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Renderizador 3D - Firebase + Netlify</title>

  <style>
    body{margin:0;background:#0b1220;color:#e5e7eb;font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif}
    main{max-width:900px;margin:0 auto;padding:20px}
    input,button{padding:12px;border-radius:10px;border:none}
    input{flex:1;background:#111827;color:#e5e7eb;border:1px solid #1f2937}
    button{background:#3b82f6;color:#fff;font-weight:600;cursor:pointer;margin-left:8px}
    .status{margin-top:10px;font-size:14px}
    .ok{color:#86efac}.err{color:#fca5a5}.warn{color:#fde68a}
    .viewer{margin-top:20px;border:1px solid #1f2937;border-radius:12px;overflow:hidden;background:#0b1020}
    model-viewer,canvas{width:100%;height:520px;display:none;background:#0b1020}
  </style>
  <script type="module" src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
  <script type="importmap">
  {
    "imports": {
      "three": "https://unpkg.com/three@0.152.2/build/three.module.js",
      "three/addons/": "https://unpkg.com/three@0.152.2/examples/jsm/"
    }
  }
  </script>
</head>
<body>
<main>
  <h1>Renderizar Modelo 3D (Firestore → Storage)</h1>
  <div style="display:flex;gap:8px">
    <input id="nome" placeholder="Digite o nome exato (ex: BUCHA)">
    <button id="buscar">Buscar</button>
  </div>
  <div id="status" class="status"></div>
  <div class="viewer">
    <model-viewer id="mv" camera-controls auto-rotate></model-viewer>
    <canvas id="cv"></canvas>
  </div>
</main>
<script type="module">
import * as THREE from 'three';
import { OBJLoader } from 'three/addons/loaders/OBJLoader.js';
import { STLLoader } from 'three/addons/loaders/STLLoader.js';

const firebaseConfig = {
  apiKey: "AIzaSyDRm8V72O97F0Jr9jquRqAB81zn7eNX-VY",
  authDomain: "graduacaofator.firebaseapp.com",
  projectId: "graduacaofator",
  storageBucket: "graduacaofator.appspot.com",
  messagingSenderId: "394958579615",
  appId: "1:394958579615:web:6d3726fe846c687300bfaa"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

const statusEl = document.getElementById('status');
const setStatus = (msg, cls="") => { statusEl.className="status "+cls; statusEl.textContent=msg; };
const mv = document.getElementById('mv');
const cv = document.getElementById('cv');

document.getElementById('buscar').addEventListener('click', async ()=>{
  const nome = document.getElementById('nome').value.trim();
  if(!nome){ setStatus('Digite um nome.','warn'); return; }
  setStatus('Buscando...','warn');
  try{
    const snap = await db.collection('models').where('nome','==',nome).limit(1).get();
    if(snap.empty){ setStatus('Nenhum resultado encontrado.','warn'); return; }
    const data = snap.docs[0].data();
    const ext = (data.fileName?.split('.').pop() || '').toLowerCase();
    const url = data.downloadURL;
    const proxied = '/.netlify/functions/fetch-3d?url=' + encodeURIComponent(url);
    if(ext === 'glb' || ext === 'gltf') renderGLTF(proxied);
    else if(ext === 'obj' || ext === 'stl') renderOBJorSTL(proxied, ext);
    else setStatus(`Formato não suportado (.${ext})`,'err');
  } catch(e){
    console.error(e);
    setStatus('Erro ao buscar.','err');
  }
});

function renderGLTF(url){
  mv.style.display='block'; cv.style.display='none';
  mv.src = url;
  setStatus('Carregando modelo GLB...','ok');
}

function renderOBJorSTL(url, kind){
  mv.style.display='none'; cv.style.display='block';
  const w = cv.clientWidth || 800, h = 520;
  cv.width = w; cv.height = h;
  const scene = new THREE.Scene();
  scene.background = new THREE.Color(0x0b1020);
  const camera = new THREE.PerspectiveCamera(45, w/h, 0.1, 1000);
  camera.position.set(2.5,2,3.5);
  const renderer = new THREE.WebGLRenderer({ canvas: cv, antialias: true });
  renderer.setSize(w, h);
  scene.add(new THREE.HemisphereLight(0xffffff, 0x202020, 1.2));
  const dir = new THREE.DirectionalLight(0xffffff, 1);
  dir.position.set(3,5,2); scene.add(dir);
  const group = new THREE.Group(); scene.add(group);
  const finish = (objOrGeo) => {
    let obj = objOrGeo;
    if(kind === 'stl'){
      obj = new THREE.Mesh(objOrGeo, new THREE.MeshStandardMaterial({ color: 0xcccccc, metalness: 0.1, roughness: 0.6 }));
    }
    obj.traverse?.(n => { if(n.isMesh && !n.material) n.material = new THREE.MeshStandardMaterial({ color: 0xcccccc }); });
    group.add(obj);
    const box = new THREE.Box3().setFromObject(group);
    const size = new THREE.Vector3(); box.getSize(size);
    const center = new THREE.Vector3(); box.getCenter(center);
    group.position.sub(center);
    const maxDim = Math.max(size.x, size.y, size.z) || 1;
    group.scale.setScalar(2 / maxDim);
    setStatus('Modelo carregado.','ok');
  };
  const onErr = (e) => { console.error(e); setStatus('Erro ao carregar (CORS ou arquivo).','err'); };
  if(kind === 'obj') new OBJLoader().load(url, finish, undefined, onErr);
  else new STLLoader().load(url, (geo) => finish(geo), undefined, onErr);
  (function anim(){
    requestAnimationFrame(anim);
    camera.lookAt(0,0,0);
    renderer.render(scene, camera);
  })();
}
</script>
</body>
</html>
